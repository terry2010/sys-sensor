# 项目总结与开发注意事项

本文档汇总 sys-sensor 项目的整体设计、技术选型、核心功能、开发与调试要点、常见问题与扩展指引。未来新增/修改功能请以此为基础信息进行。

---

## 1. 项目概述
- 目标：在 Windows 10 上通过 Tauri 打造轻量级系统传感器托盘应用，显示 CPU/内存/温度/风扇、网络与磁盘速率等信息。
- 形态：
  - 托盘“纯文本双行”图标，顶部优先显示 CPU 温度（无温度则显示 CPU%），底部显示 CPU% 或内存%（可配置）。
  - Tooltip 多行详细信息，右键菜单可打开“详情/设置/关于”页面。
- 数据：
  - 通过 .NET C# 传感器桥接（LibreHardwareMonitor）与 WMI 兜底，采集温度/风扇等硬件数据；系统资源（CPU、内存、网络、磁盘）由 Rust 侧采集与整合。

## 2. 技术栈与运行环境
- 操作系统：Windows 10（用户要求）
- 桌面框架：Tauri（Rust 后端 + Web 前端）
- 前端：Vue3 + vue-router（`src/`）
- 后端：Rust（`src-tauri/`），事件广播与托盘绘制、数据采样与合并
- 传感器桥接：C#（LibreHardwareMonitor），作为子进程提供温度/风扇等数据
- 数据平滑：差分 + 指数滑动平均（EMA）

## 3. 目录与关键路径
- `src-tauri/src/lib.rs`：
  - 采样线程（CPU/内存/网络/磁盘），单位自适应与 EMA 平滑
  - 托盘图标文本绘制（双行），动态字号与字符间距
  - 事件广播 `app.emit("sensor://snapshot")`
  - Tauri 命令（配置读取/写入、网卡枚举）
- `src/views/Settings.vue`：设置页，调用后端命令保存配置
- `src/views/Details.vue`：详情页（订阅并展示实时信息）
- `doc/dev-plan.md`：开发计划
- `doc/progress.md`：开发进度记录（必须持续更新）

注：上面仅列核心文件，其他组件随代码增长按需补充。

## 4. 核心功能与实现要点

### 4.1 传感器数据与权限
- 温度/风扇数据优先来自 .NET 传感器桥接（管理员权限下最佳）。
- 无权限或读数不可用时，使用 WMI 兜底（若仍不可用，在 UI 做出“需管理员/无读数”提示）。

### 4.2 采样与速率计算
- 网络与磁盘速率采用“累计字节差分 / Δt”并通过 EMA 平滑。
- 单位自适应：KB/s、MB/s（根据阈值切换）。
- 支持网卡白名单聚合：仅统计被选中的接口之和。

### 4.3 托盘图标文本渲染（可读性优化）
- 双行文本：
  - 上行：有温度则显示 `70C` 等；否则显示 `CPU%`。
  - 下行：显示 `CPU%` 或 `内存%`（由配置决定）。
- 动态适配策略（位于 `src-tauri/src/lib.rs`）：
  - 优先尝试大字号 `scale=2` 且字符间距 `gap=0`，最大化横向像素利用。
  - 若仍超宽，尝试“去单位”保持大字号：上行去掉 `C`，下行去掉 `%`（只影响托盘图标，Tooltip/详情完整显示）。
  - 仍不适配时，回退到 `scale=1` + `gap=1`。
- 效果：`70C`、`85%`、`100` 等常见值在 32x32 图标内清晰可读。

### 4.4 Tooltip 与菜单联动
- Tooltip 与菜单顶部信息区与详情页数据一致。
- 菜单点击打开窗口：优先复用主窗口，显示与聚焦，不重复创建。
- 关闭主窗口时隐藏（`WindowEvent::CloseRequested`），托盘“退出”菜单才真正退出。

### 4.5 配置持久化（AppConfig）
- 存储位置：Tauri AppConfig 目录下的 JSON。
- 字段：
  - `tray_show_mem: bool` —— 托盘第二行显示内存%（true）或 CPU%（false）。
  - `net_interfaces: Option<Vec<String>>` —— 网卡白名单，留空表示全部聚合。
- 后端命令：
  - `get_config()`、`set_config(new_cfg: AppConfig)`、`list_net_interfaces()`。
- 前端调用注意（Tauri v2 参数映射）：
  - JS 侧需传 `newCfg`（camelCase）对应 Rust 形参 `new_cfg`。例如：
    ```ts
    await invoke("set_config", { newCfg: new_cfg })
    ```

### 4.6 事件广播与订阅
- 后端周期性 `app.emit("sensor://snapshot")`。
- 前端在页面 `onMounted` 时订阅该事件，详情页与信息区实时更新。

## 5. 开发与调试流程

### 5.1 启动与构建
- 后端快速检查：在 `src-tauri/` 下执行 `cargo check`。
- 开发联调：在项目根目录使用包管理器脚本启动 Tauri 开发服务器（示例）
  - `npm run tauri dev` 或 `pnpm tauri dev`（以项目实际脚本为准）。

### 5.2 编辑器与进程清理（重要）
- 当前编辑器存在进程残留/端口占用问题：调试后需手动清理。
- 建议在每次调试前后执行 `taskkill` 清理相关进程，避免端口被占用导致调试失败。

### 5.3 日志与排错
- 关注 `src-tauri/` 侧控制台输出（桥接子进程启动、数据合并、异常重启）。
- 前端在浏览器控制台查看 `Settings.vue` 保存日志与可能的错误提示。
- 常见错误：
  - 设置保存时报错 `missing required key newCfg` —— 前端参数名应为 `newCfg`。
  - 温度/风扇显示为 `—` —— 多为权限或硬件读数不可用。

### 5.4 管理员与 NUC8 诊断步骤
- 场景与结论（NUC8BEB / i7-8559U 实测）：
  - 普通权限：CPU 温度/风扇多为“—”。
  - 管理员权限：CPU 温度恢复有值；风扇 RPM 仍无值（多数 NUC 平台不经标准接口公开 RPM）。
  - `bridge.admin.out.jsonl` 典型行：`{"isAdmin":true,"hasTemp":true,"hasTempValue":true,"hasFan":false,"hasFanValue":false}`。
- 现场快速诊断（管理员 PowerShell）：
  1) 进入桥接目录：
     ```powershell
     Set-Location C:\code\sys-sensor\sensor-bridge
     ```
  2) 运行管理员脚本（或直接运行发布版 exe）：
     ```powershell
     powershell -NoProfile -ExecutionPolicy Bypass -File .\run-bridge-admin-exe.ps1
     # 或：
     $env:BRIDGE_TICKS=12
     .\bin\Release\win-x64\publish\sensor-bridge.exe 1> bridge.admin.out.jsonl 2> bridge.admin.err.txt
     ```
  3) 检查输出：
     ```powershell
     Get-Content .\bridge.admin.out.jsonl -Tail 40
     Get-Content .\bridge.admin.err.txt  -Tail 200
     ```
     关注 `isAdmin/hasTemp/hasTempValue/hasFan/hasFanValue` 字段，以及 `stderr` 是否出现温度/风扇条目。
- UI 与回退策略：
  - 优先显示 CPU 风扇 RPM；无则机箱风扇 RPM；仍无则显示风扇占空比或 CPU%。托盘、Tooltip、详情页三处一致。
  - UI 提示：在 Tooltip 明确标注“NUC 平台风扇 RPM 不支持/未公开（如无值）”。

## 6. 已知限制与注意事项清单
- 温度/风扇数据在非管理员权限下可能不可用；需在 UI 明示。
- 风扇 RPM 在部分主板/风扇方案下无法读取；已做占空比（百分比）兜底显示。
- 托盘图标是 32x32 像素文本渲染，极端长文本会降级字号或去单位以保证可读性。
- 编辑器调试残留进程需手动 `taskkill` 清理。
 - Intel NUC8（NUC8BEB/i7-8559U）平台实测：普通权限无温度/RPM；管理员态 CPU 温度有值但风扇 RPM 仍无。属平台/EC 限制，应用侧已启用回退与提示。
 - WMI 常见限制：`MSAcpi_ThermalZoneTemperature` 在普通权限可能报 `0x80041003`（拒绝访问）；`Win32_Fan` 常无 `Speed/DesiredSpeed` 值。

## 7. 扩展开发指引

### 7.1 新增一个传感器字段（示例思路）
1. 在桥接端（C#）采集该传感器的值，并更新输出结构。
2. Rust 侧桥接读取并并入采样快照结构。
3. 在 `lib.rs` 的事件负载中加入该字段并 `emit`。
4. 前端页面（如 `Details.vue`）订阅并展示。
5. 如需托盘展示，评估是否放入上/下行文本并适配宽度策略。

### 7.2 新增一个设置项（示例思路）
1. 扩展 `AppConfig` 结构，补齐序列化/反序列化与默认值。
2. 在后端增加/修改相关 Tauri 命令读写配置逻辑。
3. 前端 `Settings.vue` 增加输入组件与 `invoke` 调用（注意 camelCase 参数映射）。
4. 采样/渲染处读取配置并立即生效（尽量避免重启）。

### 7.3 修改托盘文本布局/策略
- 可在 `lib.rs` 的文本宽度计算与绘制处调整：
  - 行高、垂直间距、水平居中方式
  - 大小优先级（是否更积极地去单位、是否允许 3 位数保留单位等）
  - gap 策略（scale=2 优先 gap=0，仅在必要时换到 scale=1/gap=1）

## 8. 代码规范与命名约定
- Rust：snake_case；JS 侧调用参数遵循 camelCase（Tauri v2 自动映射）。
- 事件命名：`sensor://snapshot`（保持统一前缀便于检索）。
- 文档：每次变更务必更新 `doc/progress.md`。

## 9. 版本与发布（概述）
- 开发期：`cargo check` 快速验证；使用包管理器脚本 `tauri dev` 联调。
- 发布期：使用 Tauri 打包流程（依项目脚本为准），注意签名与权限提示。

## 10. 第三方与致谢
- LibreHardwareMonitor（C# 侧传感器采集）
- Tauri、Vue3、System APIs

## 11. 变更记录
- 详见 `doc/progress.md`（所有开发进展均记录在该文件）。

## 12. 重要注意事项（Checklist）
- 托盘文本尽量保持大字号：先试 `scale=2/gap=0`，再尝试去单位，最后才降级字号。
- Settings 保存参数名：JS 传 `newCfg`，对应 Rust 形参 `new_cfg`。
- 管理员权限影响温度/风扇数据可用性；在 UI 中要给出清晰提示。
- 调试结束主动 `taskkill` 清理残留进程，避免端口占用。
- 每次开发后更新 `doc/progress.md`，并优先复用主窗口、避免重复创建。

## 13. 对标 iStat Menus 差距清单（2025-08-13）
- 当前覆盖（已实现）：
  - CPU：总占用、每核心占用/频率/温度、封装功耗、降频状态与原因。
  - 内存：已用/总量、可用、交换区（已用/总量）。
  - 磁盘：总读/写速率（B/s），容量（分区级，GB），SMART 关键属性（温度/通电/上电次数/重映射/待定/不可纠正/CRC/累计读写字节）。
  - 网络：总 RX/TX 速率、接口列表（名称/MAC/IP/速率/网关/DNS/DHCP/Up）、公网 IP 与 ISP。
  - Wi‑Fi：SSID/信号%/Link 速率、BSSID/信道/频段/制式、Rx/Tx 速率、RSSI dBm（含估算标记）、认证/加密、信道带宽。
  - GPU：温度/热点温度/VRAM 温度、核心频率、显存频率、负载%、VRAM 已用 MB、功耗 W/功率上限 PL、风扇 RPM/占空比、核心电压 V（多卡显示前 2 块，+N 汇总）。
  - 风扇：CPU/机箱等多风扇详情（名称/RPM/占空比），主板电压多路。
  - 其他：多目标 RTT、Top CPU/内存进程、电池（电量/状态/AC/剩余时间/充满时间）、存储温度摘要、运行时长与桥接心跳等。

- 与 iStat Menus 相比仍缺（优先建议）：
  1) 网络
     - 分网卡实时速率（当前仅提供总速率）；可在 `SensorSnapshot` 增加 `net_ifs_rt[{name, rx_bps, tx_bps}]`。
     - Wi‑Fi 噪声/信噪比（SNR）、发射功率、MCS/PHY index（若 API 可得）。
  2) 磁盘
     - 分物理盘/分分区读写速率与 IOPS/队列长度（当前聚合）。
     - SMART 寿命/磨损度（如 `% life used`/`wear leveling`/TBW 等，硬件/厂商支持差异大）。
  3) GPU
     - VRAM 总量与使用率%（当前仅 `vram_used_mb`，无总量）。
     - 显存控制器/视频编解码占用%（NVDEC/NVENC/MediaEngine，如可用）。
     - 多风扇 GPU 的分风扇 RPM（若采集库可区分）。
  4) 内存
     - 细分类型：缓存/可分页/不可分页/压缩等（Windows 语义对齐 iStat“App/Cached/Compressed”等）。
     - 换入/换出速率（swap in/out rate）。
  5) CPU
     - 单核功耗/温度极值、峰值保持（min/avg/max 快照/短期历史）。
     - E/P‑Core 区分展示（如可从采集库识别）。
  6) 电池
     - 设计容量/当前满充容量/循环次数/健康度%、电池温度/制造信息（Windows 能力受限，可能需 WMI/ACPI 厂商扩展）。
  7) 历史与图表
     - 短期历史曲线（CPU/GPU/网络/磁盘），采样环形缓冲区 + 轻量 sparkline。

- 兼容性与实现注意：
  - 上述部分指标依赖硬件/驱动/权限，需提供“—/不可用/需管理员”提示与回退。
  - 优先不破坏现有结构：新增字段使用可选类型并在前端按存在性渲染；保持 `snake_case`（Rust）/`camelCase`（JS）与 Tauri v2 映射约定。

---

## 7. 重要修复经验与注意事项（2025-08-15）

### 7.1 托盘菜单导航修复
**问题描述**：托盘右键菜单【快速设置】【关于我们】点击后只打开主窗口，未导航到对应页面。

**根本原因**：
- Tauri环境检测逻辑错误，导致事件监听器未注册
- 前端事件监听注册时机过早，router未初始化完成

**修复方案**：
1. **修正环境检测逻辑**：
   ```typescript
   const isTauri = typeof window !== 'undefined' && 
                   (typeof (window as any).__TAURI__ !== 'undefined' || 
                    typeof (window as any).isTauri !== 'undefined' ||
                    window.location.protocol === 'tauri:');
   ```

2. **延迟事件监听注册**：
   ```typescript
   setTimeout(() => {
     // 确保router已初始化
     listen("navigate-to-settings", () => {
       if (router) router.push('/settings');
     });
   }, 100);
   ```

3. **后端事件发送**：
   ```rust
   "quick_settings" => {
     let _ = window.emit("navigate-to-settings", ());
   }
   ```

**关键经验**：
- Tauri环境检测需考虑多种情况
- 事件监听注册需等待router初始化
- 开发模式和生产模式行为可能不同

### 7.2 SMART盘符显示修复
**问题描述**：SMART详情中盘符显示为"—"，无法显示实际盘符（如C:、D:）。

**根本原因**：
- 前后端字段名不匹配：Rust序列化`drive_letter` → `driveLetter`，但前端检查`drive_letter`
- SMART数据来源复杂：smartctl采集 + sensor-bridge采集，需要数据合并
- StorageTempPayload结构缺少盘符字段

**修复方案**：
1. **扩展数据结构**：
   ```rust
   #[derive(Clone, Serialize, Debug)]
   #[serde(rename_all = "camelCase")]
   pub struct StorageTempPayload {
       pub name: Option<String>,
       pub temp_c: Option<f32>,
       pub drive_letter: Option<String>, // 新增盘符字段
   }
   ```

2. **数据合并逻辑**：
   ```rust
   // 合并smartctl采集的盘符数据到storage_temps
   if let Some(smartctl_data) = smartctl_utils::smartctl_collect() {
       // 智能匹配设备名，合并盘符信息
       // 兼容无smartctl环境的默认映射
   }
   ```

3. **前端字段匹配修复**：
   ```typescript
   function getDriveLetter(d: any): string {
     // 优先使用driveLetter字段（Rust camelCase序列化）
     if (d.driveLetter && typeof d.driveLetter === 'string' && d.driveLetter.length > 0) {
       return d.driveLetter;
     }
     // 兼容drive_letter字段（snake_case）
     if (d.drive_letter && typeof d.drive_letter === 'string' && d.drive_letter.length > 0) {
       return d.drive_letter;
     }
     return '—';
   }
   ```

4. **盘符提取逻辑**：
   ```rust
   fn extract_drive_letter(device_path: &str) -> Option<String> {
     // 处理/dev/sda格式，映射到Windows盘符
     // PowerShell WMI查询 + 默认映射规则
     // 兼容无smartctl环境
   }
   ```

**关键经验**：
- Rust `#[serde(rename_all = "camelCase")]` 会将 `drive_letter` 序列化为 `driveLetter`
- 前后端字段名必须严格匹配，注意序列化转换
- 数据来源复杂时需要合并逻辑，确保数据完整性
- 兼容性设计：支持多种字段名格式，提供默认映射

### 7.3 调试技巧
1. **后端日志**：使用`eprintln!`添加调试日志，追踪数据流
2. **前端日志**：在事件监听和数据处理中添加`console.log`
3. **构建验证**：每次修改后重新构建，确保最新代码生效
4. **环境隔离**：区分开发模式(`npm run dev:all`)和生产模式行为差异

### 7.4 项目现状（2025-08-15）

**🔧 技术栈稳定性**：
- Tauri 2.x + Vue 3 + TypeScript 前端架构稳定
- Rust后端数据采集链路完整
- sensor-bridge C#程序集成正常
- 前后端序列化机制工作正常

**📋 开发建议**：
- 新增功能时注意前后端字段名匹配（camelCase vs snake_case）
- 事件监听注册需考虑初始化时机
- 数据结构扩展时保持向后兼容
- 调试时区分开发和生产环境行为差异
