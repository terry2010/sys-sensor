# 交互与功能设计

> 本文定义 sys-sensor 的整体交互体系与功能边界，对标 iStat Menus，覆盖 Windows 7 ~ Windows 11。

---

## 1. 总体概述
- 支持双模式：
  - 专业模式（默认）：面向资深用户，提供贴边窗口与浮动小窗口，偏信息密度与效率。
  - 用户模式：引入桌面宠物，替代浮动小窗口，以拟物/趣味交互增强体验。
- 统一异形窗口体系：
  - 鼠标经过以下入口时，弹出相同内容与主题的“异形信息窗（A-Hover）”：
    - 托盘图标
    - 任务栏图标
    - 贴边窗口（F）
    - 浮动小窗口（M，用户模式由桌面宠物代替）
  - 鼠标点击同一入口时，弹出“异形操作窗（B-Click）”，包含更多控件与操作。
- 透明穿透：异形窗口留白与透明区域必须“穿透点击”（不阻挡底层窗口交互）。
- 历史图弹窗：在任何窗口内鼠标“悬停某一指标”时，于当前窗口一侧创建“紧贴的新无边历史图窗（H-Chart）”。
- 主题系统：窗口/图表/宠物均支持主题；宠物可更换主题与动画包。
- 当前主窗口保持不变（重命名为“开发/调试窗口 D”）；新增“设置主窗口 S”为面向用户的主入口（对标 iStat Menus 设置）。

## 2. 交互入口与结果
- 托盘图标 Hover → A-Hover；Click → B-Click
- 任务栏图标 Hover → A-Hover；Click → B-Click
- 贴边窗口 Hover → A-Hover；Click → B-Click
- 浮动小窗口（专业模式）Hover → A-Hover；Click → B-Click
- 桌面宠物（用户模式）Hover → A-Hover（附宠物联动提示）；Click/DoubleClick → B-Click
- 任一窗口内“指标项 Hover” → 在旁侧新建 H-Chart（历史图）

## 3. 窗口角色与关系
- A-Hover（信息窗）：只读、轻量、异形；指标卡片网格；留白穿透。
- B-Click（操作窗）：可操作、标签/折叠区、少量快捷开关（如限速警戒、温度阈值）。
- H-Chart（历史图）：附着于父窗边缘，无边框、跟随主题；鼠标离开父+子区域延迟隐藏。
- S（设置窗）：iStat Menus 风格设置页；作为“主窗口”。
- D（开发/调试窗）：保持现有主窗口功能，供内部调试使用。
- F（贴边窗）：贴靠屏幕边缘，自动隐藏与显隐；呼起 A/B。
- M（浮动小窗）：专业模式下存在；用户模式被“桌面宠物”替代。

## 4. 透明穿透与命中规则
- 透明与留白区域采用命中测试剔除（HitTest），支持点击穿透至下层应用。
- Windows 技术要点（实现参考，不限定具体技术路径）：
  - Layered Window + 透明蒙版；`WS_EX_LAYERED` + `WS_EX_TRANSPARENT`；命中测试回调返回 `HTTRANSPARENT`。
  - Tauri 侧使用“透明窗口 + 无边框 + 点击穿透区域映射”实现；Win7 可退化为粗矩形蒙版。
- 符合以下行为：
  - 仅可交互区域响应悬停/点击；
  - 窗口外形变化不影响托盘与主程序稳定性；
  - A/H/B 均不吸收非命中区域事件。

## 5. 桌面宠物（用户模式）
- 行为：
  - 可拖拽；贴边吸附；单/双击、长按、键盘输入触发动画（如“打字→猫拍键盘”）。
  - 与系统事件联动：CPU 拉高、风扇加速、网络高流量触发对应动画。
  - 静音/暂停/低功耗模式（降低帧率）。
- 主题与资源：
  - 多宠物主题（猫/狗/像素风等）；序列帧或 Lottie/PNG 序列；Win7 建议 PNG/GIF 序列。
  - 行为脚本与事件映射可配置（JSON/YAML）。
- 安全与性能：
  - 独立渲染层，限制 CPU < 2%，内存 < 80MB（参考值）。

## 6. 历史图弹窗（H-Chart）
- 触发：任一指标 Hover 500ms（可配置）；离开父+子区域 300ms 自动隐藏。
- 位置：贴靠触发项所在窗口边；水平优先靠右，碰撞检测后自动换边。
- 样式：无边框、圆角、阴影、主题一致；支持 Light/Dark。
- 内容：最近 N 分钟（默认 5/15/60 可选）；折线/面积图；十字线 + 即时值；
- 多开策略：同一父窗同一指标只保留一个；切换指标复用窗口。

## 7. 主题与外观
- 主题变量：
  - 色板（主/辅/强调/告警）、圆角半径、阴影/模糊、字体与字号、线宽。
  - 异形轮廓（SVG/九宫格）与命中区域映射。
- 主题层级：应用主题、窗口主题、宠物主题（可独立切换）。
- 可导入/导出主题包；内置数款主题示例。

## 8. 多屏、高 DPI 与定位
- 多屏支持：窗口在触发屏幕内就近展示；跨屏边缘时进行位置修正。
- DPI 适配：矢量/高分资源，根据缩放比调整半径/描边/间距。
- 任务栏四向考虑（底/顶/左/右）；Win7 的任务栏位置变化需兼容。

## 9. 配置项（节选）
- 模式：`mode = professional | user`
- 主题：`theme.app` / `theme.window` / `theme.pet`
- 窗口：`hover_delay` / `auto_hide_delay` / `always_on_top` / `edge_dock`
- 历史图：`spans = [5,15,60]` / `sampling_hz` / `chart_style`
- 宠物：`pet.enabled` / `pet.kind` / `pet.fps_cap` / `pet.silent`

## 10. 字段命名兼容（关键）
- 原因：项目历史存在 `snake_case` 与 `camelCase` 混用。
- 规范：新增所有指标字段必须兼容两种命名。
  - 后端事件载荷建议“同时携带两个别名”（如 `vram_usage_pct` 与 `vramUsagePct`）。
  - 前端解析采用“容错读取”（`data.foo_bar ?? data.fooBar`）。
  - 文档/测试用例对两个命名均进行断言。

## 11. 不触碰约束（严禁破坏）
- 绝对禁止删除或改动 `make_tray_icon` 及相关托盘逻辑。
- 不修改托盘菜单与 tooltip 内容与行为。
- 新增窗口/主题/宠物相关逻辑须与托盘完全解耦，避免回归导致托盘双行文本变成 `---`。

## 12. 开发流程（每个功能点）
1) 修改 `sensor-bridge` C# 桥接层，补齐/校验新指标输出。
2) 修改 Rust 后端并合并桥接数据；`emit` 至前端事件。
3) 修改 Tauri 前端类型定义与 UI 绑定；兼容双命名。
4) 修改主窗口/新窗口展示；A/B/H 窗口联动。
5) 增加自动化测试（C# 与 Tauri 各一）：覆盖主窗口中对应指标。
6) 撰写/更新文档（本文件、窗口规范与测试指南）。
7) 编译并通过全部测试。

## 13. 测试与验证要点
- 自动化测试拆分为“C# 桥接层 / Tauri 后端”两部分，可分别或一次性运行；运行后生成完整报告（JSON + MD）。
- 便携版（portable）在无开发环境机器上运行测试并产出报告。
- 运行前清理残留进程（编辑器 Bug）：
```powershell
$names = @("sys-sensor.exe","sensor-bridge.exe","dotnet.exe"); foreach($n in $names){ try { taskkill /IM $n /T /F } catch {} }
```
- PowerShell 不支持 `&&`，请用分号连接命令。
- 获取显卡深度指标禁止依赖 `nvidia-smi`，统一走桥接层。

## 14. 性能与能耗目标（建议）
- A/B/H 窗口常态占用：CPU < 1%（均值），内存 < 120 MB（含前端缓存）。
- 宠物：启用时 CPU < 2%，静音/低功耗模式降至 < 1%。

## 15. 版本与兼容性
- OS：Windows 7 ~ Windows 11；Win7 部分视觉特性退化（阴影/模糊/材质）。
- DPI：100%~300% 测试通过；多屏混合 DPI 进行位置修正。

---

本文作为交互与功能的“单一事实来源”，后续改动请同步至 `doc/progress.md` 与自动化测试。
